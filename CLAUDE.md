# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Repo Is

Gaia is a **state-only** repository — no application code, no builds, no tests. It is the central index of a holistic life management ecosystem where GitHub is the source of truth, Obsidian is the read/write interface, and Claude (Code + .ai) is the intelligence layer.

All state lives in version-controlled YAML-frontmatter Markdown files. There is no custom backend.

## Architecture (5 Layers)

1. **State Store** — This repo (`Gaia`) + distributed project repos registered in `manifest.yaml`
2. **Domain Modules** — `domains/*.md` files covering health, finances, languages, social, creative, calendar, goals, work-projects, ai-projects, business-ideas
3. **Integration** — Claude Code hooks, skills, MCPs (GitHub, Google Calendar, Filesystem)
4. **Interface** — Desktop (Claude Code), Mobile (Obsidian + Git sync), Any device (Claude.ai)
5. **Temporal** — Morning planning, active work support, evening reflection via `/plan` and `/reflect` commands

## File Conventions

### Domain state files (`domains/*.md`)

Every domain file uses this schema:

```yaml
---
domain: <name>
updated: <ISO 8601 timestamp>
updated_by: <claude-code-hook | manual>
status: active
review_cycle: weekly
next_review: <date>
tags: [...]
---
```

Body sections (in order): **Current State**, **Active Goals**, **Habits & Routines**, **Recent Activity**, **Next Actions**, **Notes**, **Links**.

- "Recent Activity" is **append-only** — hooks append entries, never overwrite
- "Current State", "Goals", "Notes" are human-edited sections (typically via Obsidian)
- Cross-domain references use standard markdown links (e.g., `[calendar](calendar.md)`)

### Temporal files (`temporal/`)

- `today.md` — regenerated each morning by `/plan`, updated throughout the day by hooks
- `weekly-review.md`, `monthly-review.md` — rolling summaries generated by `/review`
- `templates/` — Templater-compatible templates for morning plan, evening reflection, weekly review

### Journal (`journal/YYYY/MM/YYYY-MM-DD.md`)

Daily logs, append-only. Created during morning planning, extended during evening reflection.

### Manifest (`manifest.yaml`)

Registry of all connected project repos. Each entry has: name, github path, domain, status, description. Used by post-session hooks to map a project back to its domain file.

### Dashboards (`dashboards/`)

Obsidian Dataview-powered aggregated views. Query YAML frontmatter across domain files.

## Write Protocols

### Hook writes (automated)

1. Always `git pull --rebase` before writing
2. Only modify: frontmatter timestamps, "Recent Activity" (append), "Next Actions"
3. On merge conflict: stage as `.pending` file, do not force-resolve

### Manual writes (Obsidian / Claude Code)

- Edit "Current State", "Active Goals", "Habits & Routines", "Notes", "Links" freely
- Avoid editing "Recent Activity" manually — it's hook-managed

## Slash Commands

All commands live in `.claude/commands/` and are invoked via `/command-name`.

| Command    | Args                | Description                                                                          |
| ---------- | ------------------- | ------------------------------------------------------------------------------------ |
| `/plan`    | —                   | Morning planning: reads all domains, generates `temporal/today.md` and journal entry |
| `/reflect` | —                   | Evening reflection: summarizes day vs plan, flags carry-forward items                |
| `/status`  | `[domain]`          | Show current state of one domain or summary table of all domains (read-only)         |
| `/update`  | `<domain>`          | Interactive walk-through of a domain's editable sections                             |
| `/review`  | `<weekly\|monthly>` | Generate periodic review from journal entries and domain activity                    |
| `/inbox`   | `<note text>`       | Route freeform text to the appropriate domain's Notes section                        |
| `/link`    | `<project>`         | Register a new repo in `manifest.yaml` and link it to a domain                       |
| `/sync`    | `[summary]`         | Manual session sync — update domain state after working in a project repo            |

### Command behaviour notes

- `/plan` and `/reflect` commit changes automatically
- `/status` is read-only — safe to run anytime
- `/update` uses interactive prompts to walk through editable sections; never touches Recent Activity
- `/sync` is designed to work from **outside** the Gaia repo (from a project repo) and pushes after committing
- All write commands follow the write protocol: pull before write, append-only for Recent Activity

## Hooks & Automation

Phase 2 adds three hooks that automate the sync loop and enrich sessions with domain context.

### SessionStart — Context injection (project-level)

**Fires:** Every session start/resume/compact in the Gaia repo.

Injects into Claude's context:

- Today's plan summary (first 20 lines of `temporal/today.md`)
- Domain snapshot: `domain`, `status`, `updated`, `next_review` from each `domains/*.md` frontmatter
- Flags any domains with overdue `next_review`

No need to run `/status` at session start — the hook provides awareness automatically.

### PreToolUse — Write protocol enforcement (project-level)

**Fires:** Before any `Edit` or `Write` tool call in the Gaia repo.

A prompt-type hook that checks if an edit to a `domains/*.md` file removes or overwrites existing entries in the `## Recent Activity` section. Recent Activity is **append-only** — the hook blocks destructive edits and allows appends.

### SessionEnd — Automatic post-session sync (global)

**Fires:** Every session end, in any repo.

The hook (`~/.claude/hooks/gaia-session-sync.ps1`):

1. Reads `cwd` from the session input
2. Checks `manifest.yaml` to see if `cwd` matches a registered project (by directory name or git remote)
3. If no match → exits silently (not a Gaia project)
4. If match:
   - Pulls latest Gaia state (`git pull --rebase`)
   - Appends to `domains/<domain>.md` Recent Activity: `- **[YYYY-MM-DD]** <project>: <last commit msg>`
   - Updates frontmatter `updated` timestamp and `updated_by: claude-code-hook`
   - Appends to `temporal/today.md` under `## Session Log`
   - Commits and pushes
5. On push failure → writes to `.pending/<timestamp>.md` for manual retry

This automates what `/sync` does manually. Every project session automatically updates Gaia's state.

### `.pending/` directory

Failed sync pushes write to `.pending/` with details of the failed operation. This directory is git-ignored. Check and retry pending syncs manually when needed.

## Important Constraints

- This repo must remain **private** (contains sensitive personal data across health, finances, relationships)
- Obsidian Git syncs every 5-10 minutes on mobile — avoid rapid successive commits that could cause conflicts
- Domain files are designed for Obsidian's properties panel — keep frontmatter keys consistent across all domain files
- The `.obsidian/workspace.json` and other local Obsidian config should be in `.gitignore`
